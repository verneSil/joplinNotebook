PayMent System

# PayMent System

## 一 支付宝
### 通知
通知时间：
```
    程序执行完后必须打印输出“success”（不包含引号）。如果商户反馈给支付宝的字符不是success这7个字符，支付宝服务器会不断重发通知，直到超过24小时22分钟。
一般情况下，25小时以内完成8次通知（通知的间隔频率一般是：4m,10m,10m,1h,2h,6h,15h）
```
## 提现账户
### 提现方式
1. 支付宝提现
2. 银联提现
3. 信用卡提现
    * 不能出现信用卡套现
    * 出现场景：使用信用卡支付押金或者可退款充值，押金或者提现提现到了银行卡。这就是信用卡套现
    * 大佬对话
        ```
            你说的这个情况，只到了支付宝的余额，不是到了银行卡。所以上一个问题是不考虑银行卡的问题
            到了余额的风控不是自己平台考虑的问题，也处理不了
            平台到了支付宝，支付宝直接处理到银行，不到支付宝余额。所以不考虑余额套现
            附录：即时到账支付宝。
        ```

## 二 项目模块
### 靠前  订单流水    
1. 订单创建
2. 拆单
    1. 设计模式：
    2. 订单结构：
        * 订单表：订单概览，订单金额
            * 评价状态
            * 退款状态
            * 支付状态
            * 物流信息id
            * 支付流水id
            * 退款流水id
            * 订单详情id
        * 订单详情表：订单下的订单商品。
        * 订单快照表：下单时商品链接，商品描述，商品金额。
        * 后期增加了商品历史，直接查询商品历史时间段快照。商品修改做了时间限制。
        * 物流信息表
        ```
        父子订单：二级订单，分开支付。但是显示界面需要整合，所以需要有一个父订单的概念。
        原子订单不支持多次支付，有些商户是支持多级支付。多级支付需要更新已支付金额字段，支付渠道信息，支付时间，退款。增加一些难度涉及，而且实用性不高。
        所属商户
        ```
    3. 拆单条件：
        * 动态启用和停止。
        * 涉及到商户系统配置，商户启用拆单，增加拆单条件。
        * 商户系统验证。
            ```
            传入商品id和商户id，验证统一性，查询商户拆单条件，动态启用
            设计模式：工厂方法，不是抽象工厂。
            ```
    4. 秒杀：
        * redis队列：list
    5. 订单缓存：不建议使用cookie。session也可以，redis也可以。防止恶意添加，订单种类有上线。20个。
    6. 订单创建的时效性：订单流程，创建后需要去支付。
### 中间  订单创建支付调用
    1. 借口的调用
    2. 参数的验证
    3. 尽量解耦，复用性强的方法调用。
    4. 支付系统参数回传的判断
    5. 支付成功/分润成功等事件结束的回调
    6. 分润的发起
    7. 优惠券/优惠券模板的使用。
    8. 订单重复支付策略
#### 中间：涉及的商户系统    
    1. 商户系统配置
    2. 商户系统：和分润挂钩
    3. 商户系统本地
    4. 支付分润暂存
### 后端  支付系统： 
后端支付系统包括：
    1. 商户层级
    2. 支付模块
    3. 优惠券模块
    4. 分润模块
#### 支付系统：商户层级
    1. 平台等级
    2. 商户级别
    3. 普通用户
#### 支付系统：订单系统
#### 支付系统：支付模块
    1. 创建支付订单
    2. 创建支付流水
    3. 拉起支付（支付宝）
    4. 支付成功：
        * 修改订单状态
        * 创建分润原子，通过mq创建分润原子，用于后续分润
#### 支付系统：优惠券模块
1. 优惠券模板：（优惠券模板数据库表）    
    * 优惠金额/优惠百分比    
    * 满减券的满减金额（也就是达到什么水准才能使用）    
    * 优惠券生成数量/单个用户可生成优惠券数量    
    * 优惠券有效期    
        * 固定时间    
        * 收到优惠券后天数   
    * 是否支持退款/全额退款才退    
2. 分发优惠券（优惠券表）
    * 优惠券模板id
    * 可用时间/过期时间
    * 归属用户
    * 是否核销
    * 过期状态
    * 满减金额
    * 用户生成的优惠券数量
3. 优惠券核销
    * 模板删除改为不可用
    * 在支付订单使用优惠券创建的时候修改为待核销
    * 在订单支付后修改为核销
    * 在订单一段时间之后没有使用，改为未核销
    * 核销后不可以
4. 优惠券模板删除
    * 逻辑删除，只是修改状态
    * 要不要修改优惠券？？
#### 支付系统：分润模块
1. 分润对象的创建：在订单支付完成，通过mq创建
2. 分润结算的创建：
    ```
    通过筛选条件，时间，订单号，便利确认都没有分润，使用同步锁，
    确保同一时间，统一条件（字符串锁）没有其他正在创建的分润
    ```
3. 确认分润：确认分润后，调用后端分润结算借口去打钱。
4. 

id: e356071b2a024d54a0b814c68fd630fd
parent_id: e8b77a1104c94488a5e6a80f8f5fa1cb
created_time: 2020-04-15T11:25:44.744Z
updated_time: 2020-04-15T11:11:00.543Z
is_conflict: 0
latitude: 0.00000000
longitude: 0.00000000
altitude: 0.0000
author: 
source_url: 
is_todo: 0
todo_due: 0
todo_completed: 0
source: joplin-desktop
source_application: net.cozic.joplin-desktop
application_data: 
order: 0
user_created_time: 2020-04-15T11:25:44.744Z
user_updated_time: 2020-04-15T11:11:00.543Z
encryption_cipher_text: 
encryption_applied: 0
markup_language: 1
is_shared: 0
type_: 1